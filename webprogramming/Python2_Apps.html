<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Python Database and Web Applications</title>

<!-- @@ start change in v1 -->
<link href="../css/programming_notes_v1.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../scripts/programming_notes_v1.js"></script>
<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon" /></head>

<body>

<div id="wrap-outer">

<!-- header filled by JavaScript -->
<div id="header" class="header-footer"><p>&nbsp;</p></div>

<div id="wrap-inner">

<div id="wrap-toc">
<h5>TABLE OF CONTENTS <a id="show-toc" href="Python2_Apps.html#show-toc">(HIDE)</a></h5>
<div id="toc"></div>  <!-- for showing the "Table of Content" -->
</div>

<div id="content-header">
<h1>Python</h1>
<h2>Database and Web Applications</h2>
</div>

<div id="content-main">

<!-- @@ end change in v1 -->

<h3 id="Python-MySQL">Python-MySQL Database Programming</h3>

<h5>References:</h5>
<ol>
<li>MySQL for Python (MySQLdb) @ <a href="http://sourceforge.net/projects/mysql-python/">http://sourceforge.net/projects/mysql-python/</a>.</li>
<li>MySQLdb User's Guide @ <a href="http://mysql-python.sourceforge.net/MySQLdb.html">http://mysql-python.sourceforge.net/MySQLdb.html</a>.</li>
</ol>

<p>I assume that you are familiar with MySQL. Otherwise, read the &quot;MySQL&quot; section.</p>

<h4 id="mysql_setup">Setting Up</h4>

<h5>(Ubuntu) Preparation</h5>

<pre class="color-command">
<span class="color-comment"># These Python packages and libraries might be needed to build the driver</span>
$ <strong>sudo apt-get update</strong>
$ <strong>sudo apt-get install python-dev libmysqlclient-dev</strong></pre>

<h5>(Python 3)(Ubuntu) Installing Python-MySQL Driver <span class="font-code">mysqlclient</span></h5>

<p>The <code>MySQLdb</code> (for Python 2) does not support Python 3. We could use <code>mysqlclient</code> (which is a fork of <code>MySQLdb</code>) or <code>PyMySQL</code> for Python 3.</p>

<p>We shall use <code>pip</code> (Python Package Manager) to install Python packages (instead of <code>apt-get</code>) to get the latest releases. See &quot;<a href="https://www3.ntu.edu.sg/home/ehchua/programming/webprogramming/Python5_IDE_Tools.html#pip">Python IDEs and Tools</a>&quot; on how to use <code>pip</code>.</p>

<pre class="color-command">
<span class="color-comment"># Install mysqlclient via pip, system-wide with sudo</span>
$ <strong>sudo pip3 install mysqlclient</strong>

<span class="color-comment"># Verify the installation</span>
$ <strong>pip3 show --files mysqlclient</strong>
Name: mysqlclient
Version: 1.3.13
Summary: Python interface to MySQL
Location: /usr/local/lib/python3.6/dist-packages
......</pre>

<h5>(Python 2)(Ubuntu) Installing Python-MySQL Driver <code>MySQLdb</code></h5>

<pre class="color-command">
<span class="color-comment"># Install MySQLdb via pip, system-wide with sudo</span>
$ <strong>sudo pip2 install MySQL-python</strong>

<span class="color-comment"># Verify the installation</span>
$ <strong>pip2 show --files MySQL-python</strong>
Name: MySQL-python
Version: 1.2.5
Summary: Python interface to MySQL
Location: /usr/local/lib/python2.7/dist-packages
......</pre>

<p>Notes: You could also use &quot;<code>apt-get install python-mysqldb</code>&quot;. But that might not install the latest version.</p>

<h5>Setting up MySQL</h5>

<p>Login to MySQL. Create a test user (called <code>testuser</code>) and a test database (called <code>testdb</code>) as follows:</p>

<pre class="color-command">
$ <strong>mysql -u root -p</strong>
......

mysql&gt; <strong>create user 'testuser'@'localhost' identified by 'xxxx';</strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong>create database if not exists testdb;</strong>
Query OK, 1 row affected (0.00 sec)

mysql&gt; <strong>grant all on testdb.* to 'testuser'@'localhost';</strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong>quit</strong></pre>

<h4 id="mysql_testdbconn">MySQL EG 1: Connecting to MySQL Database Server</h4>

<h5><span class="font-code">testdbconn.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testdbconn: Test MySQL Database Connection
&quot;&quot;&quot;</span>
import sys
import MySQLdb

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = None  <span class="color-comment"># Database connection</span>

try:
    <span class="color-comment"># Open database connection.</span>
    <span class="color-comment"># Parameters are: (server_hostname, username, password, database_name, server_port=3306)</span>
    conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')
    print('Connected...')

    <span class="color-comment"># Get a cursor from the connection, for traversing the records in result-set</span>
    cursor = conn.cursor()

    <span class="color-comment"># Execute a MySQL query via execute()</span>
    cursor.execute('SELECT VERSION()')
    <span class="color-comment">#cursor.execute('SELECT xxx')   # uncomment to trigger an exception</span>

    <span class="color-comment"># Fetch one (current) row into a tuple</span>
    version = cursor.fetchone()
    print('Database version: {}'.format(version))  <span class="color-comment"># one-item tuple</span>

except MySQLdb.Error as e:
    print('error {}: {}'.format(e.args[0], e.args[1]))  <span class="color-comment"># Error code number, description</span>
    sys.exit(1)  <span class="color-comment"># Raise a SystemExit exception for cleanup, but honor finally-block</span>

finally:
    print('finally...')
    if conn:
        <span class="color-comment"># Always close the connection</span>
        conn.close()
        print('Closed...')</pre>
</td>
</tr>
</tbody>
</table>


<h5>Output (Python 3)</h5>
<pre class="output">
sys.version_info(<span class="color-new">major=3</span>, minor=6, micro=6, releaselevel='final', serial=0)
--------------
Connected...
Database version: ('5.7.24-0ubuntu0.18.04.1',)
finally...
Closed...</pre>

<h5>Output (Python 2)</h5>
<pre class="output">
sys.version_info(<span class="color-new">major=2</span>, minor=7, micro=15, releaselevel='candidate', serial=1)
--------------
Connected...
Database version : 5.7.24-0ubuntu0.18.04.1 
finally...
Closed...</pre>

<h5>How It Works</h5>

<ol>
<li>This script shoud run on both Python 3 and Python 2. To run on Python 2, change Line 1 to <span class="color-new"><code>#!/usr/bin/env python2</code></span>. Although you need to install different MySQL driver packages for Python 3 (<code>mysqlclient</code>) and Python 2 (<code>MySQLdb</code>), both drivers use module <code>MySQLdb</code>.</li>

<li><span class="color-new font-code">print(sys.version_info)</span> (Line 9): Print the Python version for debugging. Check the <code>major=3|2</code>.</li>

<li>I use the new style formatting <code>str.format()</code>, which is supported by both Python 3 and Pythobn 2.</li>

<li>Uncomment Line 24 to trigger exception handling:
<pre class="output">
Connected...
error 1054: Unknown column 'xxx' in 'field list'
Closed...</pre>
Observe that <code>except</code> clause was run, followed by <code>finally</code>, before <code>sys.exit()</code></li>

<li>[TODO]</li>
</ol>


<h4 id="mysql_testsqlstmt">MySQL EG 2: SQL CREATE/DROP TABLE, INSERT and SELECT</h4>

<h5><span class="font-code">testsqlstmt.py</span></h5>
<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testsqlstmt: Testing MySQL statements: CREATE TABLE, INSERT and SELECT
&quot;&quot;&quot;</span>
import sys
import MySQLdb

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')

with conn:   <span class="color-comment"># Automatically close with error handling</span>
    cursor = conn.cursor()

    <span class="color-comment"># Create a new table</span>
    cursor.execute('drop table if exists cafe')
    cursor.execute('''create table if not exists cafe (
                        id int unsigned not null auto_increment,
                        category enum('tea', 'coffee') not null,
                        name varchar(50) not null,
                        price decimal(5,2) not null,
                        primary key (id)
                      )''')

    <span class="color-comment"># Insert one record</span>
    cursor.execute('''insert into cafe (category, name, price) values
                        ('coffee', 'Espresso', 3.19)''')

    <span class="color-comment"># Insert multiple records</span>
    cursor.execute('''insert into cafe (category, name, price) values
                        ('coffee', 'Cappuccino', 3.29),
                        ('coffee', 'Caffe Latte', 3.39),
                        ('tea', 'Green Tea', 2.99),
                        ('tea', 'Wulong Tea', 2.89)''')

    <span class="color-comment"># Commit the insert</span>
    conn.commit()

    <span class="color-comment"># Query all records</span>
    cursor.execute('select * from cafe')

    <span class="color-comment"># Fetch all rows from result-set into 'a tuple of tuples'</span>
    rows = cursor.fetchall()
    <span class="color-comment">#print(rows)  # For debugging</span>

    <span class="color-comment"># Process each row (tuple)</span>
    for row in rows:
        print(row)

    <span class="color-comment"># Instead of fetching all rows (which may not be feasible),</span>
    <span class="color-comment"># we can fetch row by row.</span>
    <span class="color-comment"># We also fetch the column names.</span>
    cursor.execute('select * from cafe')

    <span class="color-comment"># Fetch the column descriptions in 'a tuple of tuples'</span>
    <span class="color-comment"># Each inner tuple describes a column</span>
    desc = cursor.description
    <span class="color-comment">#print(desc)  # For debugging</span>

    <span class="color-comment"># Print header of column names (first item of inner tuple)</span>
    print('{:&lt;10s} {:&lt;20s} {:&lt;6s}'.format(desc[1][0], desc[2][0], desc[3][0]))
    print('{:10s}-{:20s}-{:6s}'.format('-'*10, '-'*20, '-'*6))  <span class="color-comment"># Print divider</span>

    for i in range(cursor.rowcount):
        row = cursor.fetchone()
        print('{:&lt;10s} {:&lt;20s} {:6.2f}'.format(row[1], row[2], row[3]))  <span class="color-comment"># Using tuple indexes</span>

    <span class="color-comment"># Another way to fetch row-by-row</span>
    cursor.execute('select * from cafe')
    while True:
        row = cursor.fetchone()
        if row == None:
            break
        print(row)</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)
--------------
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))
category   name                 price 
--------------------------------------
coffee     Espresso               3.19
coffee     Cappuccino             3.29
coffee     Caffe Latte            3.39
tea        Green Tea              2.99
tea        Wulong Tea             2.89
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))</pre>

<h5>How It Works</h5>
<ol>
<li>The <code>with conn:</code> statement always closes the <code>conn</code>, and provide error handling.</li>
<li>[TODO]</li>
</ol>

<h4 id="mysql_testdictcursor">MySQL EG 3: Using Dictionary Cursor</h4>

<h5><span class="font-code">testdictcursor.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testdictcursor: Using Dictionary Cursor
&quot;&quot;&quot;</span>
import sys
import MySQLdb

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')

with conn:
    <span class="color-comment"># Using a dictionary cursor.</span>
    <span class="color-comment"># Each row of the result-set is a dictionary of column names and values</span>
    cursor = conn.cursor(MySQLdb.cursors.DictCursor)
    cursor.execute('drop table if exists cafe')
    cursor.execute('''create table if not exists cafe (
                     id int unsigned not null auto_increment,
                     category enum('tea', 'coffee') not null,
                     name varchar(50) not null,
                     price decimal(5,2) not null,
                     primary key (id)
                   )''')
    cursor.execute('''insert into cafe (category, name, price) values
                     ('coffee', 'Espresso', 3.19),
                     ('coffee', 'Cappuccino', 3.29),
                     ('coffee', 'Caffe Latte', 3.39),
                     ('tea', 'Green Tea', 2.99),
                     ('tea', 'Wulong Tea', 2.89)''')
    conn.commit()  <span class="color-comment"># Commit the insert</span>

    <span class="color-comment"># Query all records</span>
    cursor.execute('select * from cafe')

    <span class="color-comment"># Fetch all rows from result-set into 'a tuple of dictionary'</span>
    rows = cursor.fetchall()
    <span class="color-comment">#print(rows)  # For debugging</span>

    <span class="color-comment"># Process each row (dictionary)</span>
    for row in rows:
        <span class="color-comment">#print(row)  # For debugging</span>
        print('{}: {}'.format(row['category'], row['name']))  <span class="color-comment"># via dictionary keys</span>
</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)
--------------
coffee: Espresso
coffee: Cappuccino
coffee: Caffe Latte
tea: Green Tea
tea: Wulong Tea</pre>


<h5>How It Works</h5>
<ol>
<li>[TODO]</li>
</ol>

<h4 id="mysql_testpreparedstmt">MySQL EG 4: Using Prepared-Statements</h4>

<h5><span class="font-code">testpreparedstmt.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testpreparedstmt: Using SQL Prepared-Statement
&quot;&quot;&quot;</span>
import sys
import MySQLdb

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')

with conn:
    cursor = conn.cursor()
    cursor.execute('drop table if exists cafe')
    cursor.execute('''create table if not exists cafe (
                        id int unsigned not null auto_increment,
                        category enum('tea', 'coffee') not null,
                        name varchar(50) not null,
                        price decimal(5,2) not null,
                        primary key (id)
                      )''')

    <span class="color-comment"># Using prepared-statement via printf-like formatting specifiers</span>
    <span class="color-comment"># Use %s for all fields?!</span>
    sql = 'insert into cafe (category, name, price) values (%s, %s, %s)'

    <span class="color-comment"># Execute for one set of data</span>
    cursor.execute(sql, ('coffee', 'Espresso', 3.19))

    <span class="color-comment"># Execute for more than one set of data</span>
    data = [('coffee', 'Cappuccino', 3.29),
            ('coffee', 'Caffe Latte', 3.39),
            ('tea', 'Green Tea', 2.99),
            ('tea', 'Wulong Tea', 2.89)]
    cursor.executemany(sql, data)
    conn.commit()  <span class="color-comment"># Commit the insert</span>

    cursor.execute('select * from cafe')
    rows = cursor.fetchall()
    for row in rows:
        print(row)

    <span class="color-comment"># Another example</span>
    item = 'Cappuccino'
    cursor.execute('update cafe set price = price * 1.1 where name = %s', (item,))  <span class="color-comment"># or one-element list: [item]</span>
    cursor.execute('select * from cafe where name = %s', [item])
    row = cursor.fetchone()
    print(row)</pre>
</td>
</tr>
</tbody>
</table>


<h5>Output</h5>
<pre class="output">
sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)
--------------
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))
./testpreparedstmt_p3.py:46: Warning: (1265, "Data truncated for column 'price' at row 2")
  cursor.execute('update cafe set price = price * 1.1 where name = %s', (item,))  # or one-element list: [item]
(2, 'coffee', 'Cappuccino', Decimal('3.62'))</pre>

<h5>How It Works</h5>
<ol>
<li>Python MySQLdb supports prepared-statements via printf formatting specifiers.</li>
<li>[TODO]</li>
</ol>

<h4 id="mysql_testtran">MySQL EG 5: Managing Transactions</h4>

<h5><span class="font-code">testtran.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testtran: Testing SQL Transaction of commit and rollback
&quot;&quot;&quot;</span>
import sys
import MySQLdb

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = None

try:
    conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')

    cursor = conn.cursor()
    <span class="color-comment"># A transaction is started silently when the cursor is created.</span>
    <span class="color-comment"># No BEGIN statement is needed.</span>
    cursor.execute('drop table if exists cafe')
    cursor.execute('''create table if not exists cafe (
                     id int unsigned not null auto_increment,
                     category enum('tea', 'coffee') not null,
                     name varchar(50) not null,
                     price decimal(5,2) not null,
                     primary key (id)
                   )''')
    conn.commit()

    cursor.execute(&quot;insert into cafe values (NULL, 'coffee', 'Espresso', 3.19)&quot;)
    cursor.execute(&quot;insert into cafe values (NULL, 'coffee', 'Cappuccino', 3.29)&quot;)
    conn.commit()

    cursor.execute(&quot;insert into cafe values (NULL, 'tea', 'Green Tea', 2.99)&quot;)
    <span class="color-comment">#cursor.execute(&quot;insert into cafe (xxx) values ('tea')&quot;)  # uncomment to trigger an error</span>
    cursor.execute(&quot;insert into cafe values (NULL, 'tea', 'Wulong Tea', 2.89)&quot;)
    conn.commit()

except MySQLdb.Error as e:
    print('error {}: {}'.format(e.args[0], e.args[1]))
    if conn:
        conn.rollback()
        print('rolled back...')
    sys.exit(1)  <span class="color-comment"># Raise a SystemExit exception for cleanup, but honor finally-block</span>

finally:
    print('finally...')
    if conn:
        cursor.execute('select * from cafe')
        rows = cursor.fetchall()
        for row in rows:
            print(row)
        conn.close()</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)
--------------
finally...
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'tea', 'Green Tea', Decimal('2.99'))
(4, 'tea', 'Wulong Tea', Decimal('2.89'))</pre>

<h5>How It Works</h5>
<ol>
<li>Uncomment Line 34 to trigger exception handling and rollback.
<pre class="output">
error 1054: Unknown column 'xxx' in 'field list'
rolled back...
finally...
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))</pre>
Observe that changes after the last commit (Line 33 <code>insert</code> with <code>id=3</code>) were discarded.</li>

<li>[TODO]</li>
</ol>

<h5>Using <span class="font-code">with</span> statement</h5>
<p>We can also use <code>with</code> statement, which provide automatic <code>commit</code> and <code>rollback</code>.</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testtranwith: Testing Transaction (commit/rollback) under with-statement
&quot;&quot;&quot;</span>
import sys
import MySQLdb

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')

try:
    with conn:   <span class="color-comment"># Provide automatic commit and rollback</span>
        cursor = conn.cursor()
        cursor.execute('drop table if exists cafe')
        cursor.execute('''create table if not exists cafe (
                         id int unsigned not null auto_increment,
                         category enum('tea', 'coffee') not null,
                         name varchar(50) not null,
                         price decimal(5,2) not null,
                         primary key (id)
                       )''')
        <span class="color-comment">#conn.commit()   # auto commit for create table</span>

        cursor.execute(&quot;insert into cafe values (NULL, 'tea', 'Green Tea', 2.99)&quot;)
        <span class="color-comment">#cursor.execute(&quot;insert into cafe (xxx) values ('tea')&quot;)  # uncomment to trigger an error</span>
        cursor.execute(&quot;insert into cafe values (NULL, 'tea', 'Wulong Tea', 2.89)&quot;)

        cursor.execute('select * from cafe')
        rows = cursor.fetchall()
        for row in rows: print(row)

except MySQLdb.Error as e:
    print('error {}: {}'.format(e.args[0], e.args[1]))
    <span class="color-comment"># auto rollback</span>
    <span class="color-comment">#if conn:</span>
    <span class="color-comment">#    conn.rollback()</span>
    sys.exit(1)  <span class="color-comment"># Raise a SystemExit exception for cleanup, but honor finally-block</span>

finally:
    print('finally...')
    if conn:
        cursor.execute('select * from cafe')
        rows = cursor.fetchall()
        print(rows)   <span class="color-comment"># for debugging</span>
        for row in rows: print(row)
        conn.close()</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
sys.version_info(major=3, minor=6, micro=6, releaselevel='final', serial=0)
--------------
(1, 'tea', 'Green Tea', Decimal('2.99'))
(2, 'tea', 'Wulong Tea', Decimal('2.89'))
finally...
......</pre>

<h5>How It Works</h5>
<ol>
<li>Uncomment Line 27 to trigger exception handling and rollback:
<pre class="output">
error 1054: Unknown column 'xxx' in 'field list'
finally...
()</pre>
Observe that the table is created (auto-commit), but all insertions were rolled back resulted in an empty table.
</li>
<li>[TODO]</li>
</ol>


<h3 id="Python-PostgreSQL">Python-PostgreSQL Database Programming</h3>

<h5>References:</h5>
<ol>
<li><code>Psycopg2</code> @ <a href="http://initd.org/psycopg/">http://initd.org/psycopg/.</a></li>
<li><code>Psycopg2</code> Documentation &amp; API @ <a href="http://initd.org/psycopg/docs/">http://initd.org/psycopg/docs/</a>.</li>
<li>[TODO]</li>
</ol>

<p>I assume that you are familiar with PostgreSQL. Otherwise, read the &quot;PostgreSQL&quot; section.</p>

<h4>Setting Up</h4>

<h5>Installing Python-PostgreSQL Driver: <code>psycopg2</code></h5>

<pre class="color-command">
<span class="color-comment"># These packages might be needed to build psycopg2</span>
$ <strong>sudo apt-get update</strong>
   <span class="color-comment"># Update package list</span>
$ <strong>sudo apt-get install postgresql-server-dev-10 libpq-dev python-dev</strong>

<span class="color-comment"># Install psycopg2 via pip3 (for Python 3)</span>
$ <strong>sudo pip3 install psycopg2</strong>
Successfully installed psycopg2
<span class="color-comment"># Verify the installation</span>
$ <strong>pip3 show --files psycopg2</strong>
Name: psycopg2
Version: 2.7.6.1
Location: /usr/local/lib/python3.6/dist-packages
......

<span class="color-comment"># Install psycopg2 via pip (for Python 2)</span>
$ <strong>sudo pip2 install psycopg2</strong>
Successfully installed psycopg2
<span class="color-comment"># Verify the installation</span>
$ <strong>pip2 show --files psycopg2</strong>
Name: psycopg2
Version: 2.6.2
Location: /usr/local/lib/python2.7/dist-packages
......</pre>

<p>Notes: You may also use &quot;<code>apt-get install python-psycopg2</code>&quot; to install <code>psycopg2</code>. However, you might not get the latest version.</p>

<h5>Setting Up PostgreSQL</h5>

<p>Create a test user (called <code>testuser</code>) and a test database (called <code>testdb</code> owned by <code>testuser</code>) as follows:</p>

<pre class="color-command">
<span class="color-comment"># Create a new PostgreSQL user called testuser, allow user to login, but NOT creating databases</span>
$ <strong>sudo -u postgres createuser --login --pwprompt testuser</strong>
Enter password for new role: xxxx

<span class="color-comment"># Create a new database called testdb, owned by testuser.</span>
$ <strong>sudo -u postgres createdb --owner=testuser testdb</strong></pre>

<p>Tailor the PostgreSQL configuration file <code>/etc/postgresql/9.5/main/pg_hba.conf</code> to allow user <code>testuser</code> to login to PostgreSQL server, by adding the following entry:</p>

<pre class="color-command">
<span class="color-comment"># TYPE  DATABASE    USER        ADDRESS          METHOD</span>
local   testdb      testuser                     md5</pre>

<p>Restart PostgreSQL server:</p>
<pre class="color-command">
$ <strong>sudo service postgresql restart</strong></pre>

<h4>PG EG 1: Connecting to MySQL Database Server</h4>

<h5><span class="font-code">testdbconn.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testdbconn: Testing PostgreSQL database connection
&quot;&quot;&quot;</span>
import sys
import psycopg2

print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')
conn = None

try:
    <span class="color-comment"># Open database connection.</span>
    conn = psycopg2.connect(database='testdb', user='testuser', password='xxxx', host='localhost', port='5432')
    print('Connected...')

    <span class="color-comment"># Get a cursor from the connection, for traversing the records in result-set</span>
    cursor = conn.cursor()

    <span class="color-comment"># Execute a MySQL query via execute()</span>
    cursor.execute('SELECT VERSION()')
    cursor.execute('SELECT xxx')   <span class="color-comment"># uncomment to trigger an exception</span>

    <span class="color-comment"># Fetch one (current) row into a tuple</span>
    version = cursor.fetchone()
    print('Database version: {}'.format(version))  <span class="color-comment"># one-item tuple</span>

except psycopg2.DatabaseError as e:
    print('Error code {}: {}'.format(e.pgcode, e))
    sys.exit(1)  <span class="color-comment"># Raise a SystemExit exception for cleanup, but honor finally-block</span>

finally:
    print('finally...')
    if conn:
        <span class="color-comment"># Always close the connection</span>
        conn.close()
        print('Closed...')</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output (Python 3)</h5>
<pre class="output">
sys.version_info(major=3, minor=6, micro=7, releaselevel='final', serial=0)
--------------
Connected...
Database version: ('PostgreSQL 10.6 (Ubuntu 10.6-0ubuntu0.18.04.1) ......)
finally...
Closed...</pre>

<h5>Output (Python 2)</h5>
<pre class="output">
sys.version_info(major=2, minor=7, micro=15, releaselevel='candidate', serial=1)
--------------
Connected...
Database version: ('PostgreSQL 10.6 (Ubuntu 10.6-0ubuntu0.18.04.1) ......)
finally...
Closed...</pre>

<h5>How It Works</h5>

<ol>
<li>The above code runs under Python 3 as well as Python 2. Modify the first line to choose the Python interpreter if running standalone.</li>

<li>Try un-comment Line 23 to trigger exception handling:
<pre class="output">
sys.version_info(major=3, minor=6, micro=7, releaselevel='final', serial=0)
--------------
Connected...
Error code 42703: column "xxx" does not exist
......
finally...
Closed...
</pre></li>

<li>[TODO] more</li>
</ol>


<h4>PG EG 2: SQL CREATE/DROP TABLE, INSERT and SELECT</h4>

<p>This example uses Python's <code>with</code> statement to automatic commit and close resources. This requires <code>psycopg 2.5</code> or above.  If your <code>psycopg2</code> is lower than 2.5, use <code>try-except-finally</code> statement, as in Example 1.</p>

<h5><span class="font-code">testsqlstmts.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testsqlstmts: Testing SQL statements: CREATE TABLE, INSERT, SELECT
&quot;&quot;&quot;</span>
import psycopg2

import sys
print(sys.version_info)   <span class="color-comment"># Print Python version for debugging</span>
print('--------------')

with psycopg2.connect(database='testdb',
                      user='testuser',
                      password='xxxx',
                      host='localhost',
                      port='5432') as conn:
    with conn.cursor() as cursor:
        <span class="color-comment"># Create a new table</span>
        cursor.execute('drop table if exists cafe')
        cursor.execute('''create table if not exists cafe (
                            id serial,
                            category varchar(10) not null,
                            name varchar(50) not null,
                            price decimal(5,2) not null,
                            primary key (id)
                          )''')
        <span class="color-comment"># Insert records</span>
        cursor.execute('''insert into cafe (category, name, price) values
                            ('coffee', 'Espresso', 3.19),
                            ('coffee', 'Cappuccino', 3.29),
                            ('coffee', 'Caffe Latte', 3.39),
                            ('tea', 'Green Tea', 2.99),
                            ('tea', 'Wulong Tea', 2.89)''')
        <span class="color-comment"># Commit the insert</span>
        conn.commit()
        <span class="color-comment"># Query all records</span>
        cursor.execute('select * from cafe')
        <span class="color-comment"># Fetch all rows from result-set into 'a tuple of tuples'</span>
        rows = cursor.fetchall()
        <span class="color-comment">#print(rows)  For debugging</span>
        <span class="color-comment"># Process each row (tuple)</span>
        for row in rows: print(row)

        <span class="color-comment"># Instead of fetching all rows (which may not be feasible),</span>
        <span class="color-comment"># we can fetch row by row.</span>
        <span class="color-comment"># We also fetch the column names.</span>
        cursor.execute('select * from cafe')

        <span class="color-comment"># Fetch the column descriptions in 'a tuple of tuples'</span>
        <span class="color-comment"># Each inner tuple describes a column</span>
        desc = cursor.description
        <span class="color-comment">#print(desc)  # For debugging</span>

        <span class="color-comment"># Print header of column names (first item of inner tuple)</span>
        print('{:&lt;10s} {:&lt;20s} {:&lt;6s}'.format(desc[1][0], desc[2][0], desc[3][0]))
        print('{:10s}-{:20s}-{:6s}'.format('-'*10, '-'*20, '-'*6))  <span class="color-comment"># Print divider</span>

        for i in range(cursor.rowcount):
            row = cursor.fetchone()
            print('{:&lt;10s} {:&lt;20s} {:6.2f}'.format(row[1], row[2], row[3]))  <span class="color-comment"># Using tuple indexes</span>

        <span class="color-comment"># Another way to fetch row-by-row</span>
        cursor.execute('select * from cafe')
        while True:
            row = cursor.fetchone()
            if row == None: break
            print(row)</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
sys.version_info(major=2, minor=7, micro=15, releaselevel='candidate', serial=1)
--------------
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))
category   name                 price 
--------------------------------------
coffee     Espresso               3.19
coffee     Cappuccino             3.29
coffee     Caffe Latte            3.39
tea        Green Tea              2.99
tea        Wulong Tea             2.89
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))</pre>

<h5>How It Works</h5>
<ol>
<li>As explained in <a href="http://initd.org/psycopg/docs/usage.html">http://initd.org/psycopg/docs/usage.html</a>, starting from psycopg 2.5, the connection and cursor are <em>context manager</em> and can be used with Python's <code>with</code>-statement.
<ul>
<li>When a connection exits the with block, the transaction is committed if no exception has been raised; otherwise, it is rolled back.</li>

<li>When a cursor exits the with block it is closed, releasing any resource eventually associated with it. The state of the transaction is not affected.</li>
</ul>

</li>
</ol>

<p>Alternatively,</p>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testwith: Testing with-statement
&quot;&quot;&quot;</span>
import psycopg2

conn = psycopg2.connect(database='testdb',
                        user='testuser',
                        password='xxxx',
                        host='localhost',
                        port='5432')

with conn:
    with conn.cursor() as cursor:
        <span class="color-comment"># Create a new table</span>
        cursor.execute('drop table if exists cafe')
        cursor.execute('''create table if not exists cafe (
                            id serial,
                            category varchar(10) not null,
                            name varchar(50) not null,
                            price decimal(5,2) not null,
                            primary key (id)
                          )''')
        <span class="color-comment"># Insert records</span>
        cursor.execute('''insert into cafe (category, name, price) values
                            ('coffee', 'Espresso', 3.19),
                            ('coffee', 'Cappuccino', 3.29),
                            ('coffee', 'Caffe Latte', 3.39),
                            ('tea', 'Green Tea', 2.99),
                            ('tea', 'Wulong Tea', 2.89)''')
<span class="color-comment"># automatic commit when conn exits</span>

with conn:
    with conn.cursor() as cursor:
        <span class="color-comment"># Query all records</span>
        cursor.execute('select * from cafe')
        <span class="color-comment"># Fetch all rows from result-set into 'a tuple of tuples'</span>
        rows = cursor.fetchall()
        <span class="color-comment">#print(rows)  For debugging</span>
        <span class="color-comment"># Process each row (tuple)</span>
        for row in rows:
            print(row)

conn.close()  <span class="color-comment"># Need to close connection manually</span></pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))</pre>

<h5>How It Works</h5>
<ol>
<li>[TODO]</li>
</ol>


<h4>PG EG 3: Dictionary Cursor</h4>

<h5><span class="font-code">testdictcursor.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testdictcursor: Using PostgreSQL Dictionary Cursor
&quot;&quot;&quot;</span>
import psycopg2
import psycopg2.extras   <span class="color-comment"># Needed for dictionary cursor</span>

with psycopg2.connect(database='testdb',
                      user='testuser',
                      password='xxxx',
                      host='localhost',
                      port='5432') as conn:

    <span class="color-comment"># Create a dictionary cursor</span>
    with conn.cursor(cursor_factory=psycopg2.extras.DictCursor) as cursor:
        cursor.execute('drop table if exists cafe')
        cursor.execute('''create table if not exists cafe (
                            id serial,
                            category varchar(10) not null,
                            name varchar(50) not null,
                            price decimal(5,2) not null,
                            primary key (id)
                          )''')
        cursor.execute('''insert into cafe (category, name, price) values
                            ('coffee', 'Espresso', 3.19),
                            ('coffee', 'Cappuccino', 3.29),
                            ('coffee', 'Caffe Latte', 3.39),
                            ('tea', 'Green Tea', 2.99),
                            ('tea', 'Wulong Tea', 2.89)''')
        conn.commit()
        cursor.execute('select * from cafe')
        rows = cursor.fetchall()
        for row in rows:
            <span class="color-comment">#print(row)  For debugging</span>
            <span class="color-comment"># Using column names</span>
            print(&quot;%8s %20s %6.2f&quot; % (row['category'], row['name'], row['price']))</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
  coffee             Espresso   3.19
  coffee           Cappuccino   3.29
  coffee          Caffe Latte   3.39
     tea            Green Tea   2.99
     tea           Wulong Tea   2.89</pre>

<h5>How It Works</h5>
<ol>
<li>[TODO]</li>
</ol>


<h4>PG EG 4: Using Prepared-Statements</h4>

<h5><span class="font-code">testprepared.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testprepared: Testing SQL prepared statements: CREATE TABLE, INSERT, SELECT
&quot;&quot;&quot;</span>
import psycopg2

with psycopg2.connect(database='testdb',
                      user='testuser',
                      password='xxxx',
                      host='localhost',
                      port='5432') as conn:
    with conn.cursor() as cursor:
        cursor.execute('drop table if exists cafe')
        cursor.execute('''create table if not exists cafe (
                            id serial,
                            category varchar(10) not null,
                            name varchar(50) not null,
                            price decimal(5,2) not null,
                            primary key (id)
                          )''')

        <span class="color-comment"># Using prepared-statement via printf formatting specifiers</span>
        <span class="color-comment"># Use %s for all fields?!</span>
        sql = 'insert into cafe (category, name, price) values (%s, %s, %s)'

        <span class="color-comment"># Execute for one set of data</span>
        cursor.execute(sql, ('coffee', 'Espresso', 3.19))

        <span class="color-comment"># Execute for more than one set of data</span>
        data = [('coffee', 'Cappuccino', 3.29),
                ('coffee', 'Caffe Latte', 3.39),
                ('tea', 'Green Tea', 2.99),
                ('tea', 'Wulong Tea', 2.89)]
        cursor.executemany(sql, data)
        conn.commit()  <span class="color-comment"># Commit the insert</span>

        cursor.execute('select * from cafe')
        rows = cursor.fetchall()
        for row in rows:
            print(row)

        <span class="color-comment"># Another example</span>
        item = 'Cappuccino'
        cursor.execute('update cafe set price = price * 1.1 where name = %s', (item,))
            <span class="color-comment"># the second argument must be either a tuple or a list</span>
        item_tuple = (item,)
        cursor.execute('select * from cafe where name = %s', item_tuple)
        row = cursor.fetchone()
        print(row)</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'coffee', 'Caffe Latte', Decimal('3.39'))
(4, 'tea', 'Green Tea', Decimal('2.99'))
(5, 'tea', 'Wulong Tea', Decimal('2.89'))
(2, 'coffee', 'Cappuccino', Decimal('3.62'))</pre>

<h5>How It Works</h5>
<ol>
<li>[TODO]</li>
</ol>


<h4>PG EG 5: Transaction Management</h4>

<h5><span class="font-code">testtran.py</span></h5>

<table class="table-program">
<col class="col-line-number" />
<col class="col-program" />
<tbody>
<tr>
<td>
<pre class="text-right">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre>
</td>
<td>
<pre>
<span class="color-comment">#!/usr/bin/env python3</span>
<span class="color-comment"># -*- coding: utf-8 -*-</span>
<span class="color-comment">&quot;&quot;&quot;
testtran: Test transaction commit and rollback
&quot;&quot;&quot;</span>
import sys
import psycopg2

conn = None

try:
    conn = psycopg2.connect(database='testdb', user='testuser', password='xxxx', host='localhost', port='5432')
    cursor = conn.cursor()
    <span class="color-comment"># A transaction is started silently when the cursor is created.</span>
    <span class="color-comment"># No BEGIN statement is needed.</span>
    cursor.execute('drop table if exists cafe')
    cursor.execute('''create table if not exists cafe (
                        id serial,
                        category varchar(10) not null,
                        name varchar(50) not null,
                        price decimal(5,2) not null,
                        primary key (id)
                      )''')
    conn.commit()

    cursor.execute(&quot;insert into cafe values (DEFAULT, 'coffee', 'Espresso', 3.19)&quot;)
       <span class="color-comment"># PostgreSQL uses DEFAULT (instead of NULL in MySQL)</span>
    cursor.execute(&quot;insert into cafe values (DEFAULT, 'coffee', 'Cappuccino', 3.29)&quot;)
    conn.commit()

    cursor.execute(&quot;insert into cafe values (DEFAULT, 'tea', 'Green Tea', 2.99)&quot;)
    <span class="color-comment">#cursor.execute(&quot;insert into cafe (xxx) values ('tea')&quot;)  # uncomment to trigger an error</span>
    cursor.execute(&quot;insert into cafe values (DEFAULT, 'tea', 'Wulong Tea', 2.89)&quot;)
    conn.commit()

except psycopg2.DatabaseError as e:
    print('error code {}: {}'.format(e.pgcode, e))
    if conn:
        conn.rollback()
        print('rolled back...')
    sys.exit(1)  <span class="color-comment"># Raise a SystemExit exception for cleanup, but honor finally-block</span>

finally:
    print('finally...')
    if conn:
        cursor.execute('select * from cafe')
        rows = cursor.fetchall()
        for row in rows:
            print(row)
        <span class="color-comment"># Always close the connection</span>
        conn.close()
        print('Closed...')</pre>
</td>
</tr>
</tbody>
</table>

<h5>Output</h5>
<pre class="output">
finally...
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
(3, 'tea', 'Green Tea', Decimal('2.99'))
(4, 'tea', 'Wulong Tea', Decimal('2.89'))
Closed...</pre>

<h5>How It Works</h5>
<ol>
<li>Uncomment Line 32 to trigger exception handling:
<pre class="output">
error code 42703: column "xxx" of relation "cafe" does not exist
LINE 1: insert into cafe (xxx) values ('tea')
rolled back...
finally...
(1, 'coffee', 'Espresso', Decimal('3.19'))
(2, 'coffee', 'Cappuccino', Decimal('3.29'))
Closed...</pre></li>

<li>[TODO]</li>
</ol>


<h3 id="webapp">Python Web Applications without Framework</h3>

<p>In this section, I shall present an example of Python webapp, running under Apache 2.4 and MySQL 5.6 (or PostgreSQL), without using a Python webapp framework (such as Django or Flask).</p>

<h5>Configuring Apache</h5>
<p>I assume that you have installed Apache 2.4 and are familiar with Apache (otherwise, check out the Apache section).</p>
<p>To check your apache version:</p>

<pre class="color-command">
$ <strong>apachectl -version</strong>
Server version: Apache/2.4.18 (Ubuntu)
Server built:   2016-07-14T12:32:26</pre>

<p>Python scripts are run as cgi script under Apache. Goto <code>/etc/apache2/mods-enabled/</code>, check if apache's modules <code>cgi</code> and <code>mpm_prefork</code> are enabled. If not,</p>

<pre class="color-command">
$ <strong>sudo a2enmod mpm_prefork cgi</strong>
   <span class="color-comment"># You might need to disable module mpm_event</span></pre>

<p>Create the home directory for our webapp, say <code>/var/www/mypython-test</code>:</p>
<pre class="color-command">
$ <strong>sudo mkdir /var/www/mypython-test</strong></pre>
   
<p>Create a port-based virtual host for our webapp on port 8100, by creating a new configuration file <code>mypython-test.conf</code> in <code>/etc/apache2/sites-available</code>.</p>

<pre class="color-command">
$ <strong>cd /etc/apache2/sites-available</strong>
$ <strong>gksu gedit mypython-test.conf</strong></pre>

<pre class="color-example">
&lt;VirtualHost *:8100&gt;
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/mypython-test

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    &lt;Directory /var/www/mypython-test&gt;
        Options Indexes FollowSymLinks ExecCGI
        DirectoryIndex index.py
        <span class="color-comment"># apache 2.4</span>
        Require all granted
    &lt;/Directory&gt;
    AddHandler cgi-script .py
&lt;/VirtualHost&gt;</pre>

<p>Edit <code>/etc/apache2/ports.conf</code> to add &quot;<code>Listen 8100</code>&quot;.</p>

<p>Make the new configuration available:</p>
<pre class="color-command">
$ <strong>sudo a2ensite mypython-test</strong>
$ <strong>sudo service apache2 reload</strong></pre>

<p>You can now access the webapp via <code>http://localhost:8100/</code>, which shall show an empty directory at this moment.</p>

<h5>Setup MySQL/PostgreSQL</h5>
<p>Configure MySQL/PostgreSQL, by creating a user (called <code>testuser</code>) and a database (called <code>testdb</code>). See previous sections.</p>

<h5>Write the Web Page in Python Script</h5>

<p>Create a new Python script called <code>index.py</code> under <code>/var/www/mypython-test</code>, as follows:</p>

<pre class="color-example">
<span class="color-comment">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
&quot;&quot;&quot;
index: Test home page
&quot;&quot;&quot;</span>
<span class="color-comment"># Turn on debug mode to show the error message. To disable for production.</span>
import cgitb
cgitb.enable()

<span class="color-comment"># Print HTML response header, followed by a new line</span>
print("Content-Type: text/html\n")

<span class="color-comment"># For MySQL</span>
import MySQLdb
conn = MySQLdb.connect('localhost', 'testuser', 'xxxx', 'testdb')
<span class="color-comment"># For PostgreSQL</span>
#import psycopg2
#conn = psycopg2.connect(database='testdb', user='testuser', password='xxxx', host='localhost', port='5432')

with conn:
    cursor = conn.cursor()
    <span class="color-comment"># Create table</span>
    cursor.execute('drop table if exists cafe')
    cursor.execute('''create table if not exists cafe (
                        id int unsigned not null auto_increment,
                        category enum('tea', 'coffee') not null,
                        name varchar(50) not null,
                        price decimal(5,2) not null,
                        primary key (id)
                      )''')
    <span class="color-comment"># Insert rows</span>
    cursor.execute('''insert into cafe (category, name, price) values
                        ('coffee', 'Espresso', 3.19),
                        ('coffee', 'Cappuccino', 3.29),
                        ('coffee', 'Caffe Latte', 3.39),
                        ('tea', 'Green Tea', 2.99),
                        ('tea', 'Wulong Tea', 2.89)''')
    <span class="color-comment"># Commit the insert</span>
    conn.commit()

    <span class="color-comment"># Query all records</span>
    cursor.execute('select * from cafe')
    rows = cursor.fetchall()
    for row in rows:
        print('&lt;p&gt;' + str(row) + '&lt;/p&gt;')   <span class="color-comment"># Print HTML paragraphs</span></pre>
        
<p>Note: For Python 2, change the first line to <code>python2</code>.</p>

<p>Set permissions read and execute for Apache's user <code>www-data</code>.</p>

<pre class="color-command">
$ <strong>cd /var/www/mypython-test</strong>
$ <strong>sudo chmod 755 index.py</strong></pre>

<p>Try running the Python script, by itself:</p>
<pre class="color-command">
$ <strong>/var/www/mypython-test/index.py</strong></pre>

<h5>Run the Webapp</h5>
<p>Now, access the page via <code>http://localhost:8100</code>. If error 50x occurs, check the apache log @ <code>/var/log/apache2/error.log</code>.</p>


<h3 id="debug">Debugging Python Webapps</h3>

<h5>Under Eclipse-PyDev</h5>
<p>[TODO]</p>

<h5>Under PyCharm</h5>
<p>[TODO]</p>

<!-- @@ start change in v1 -->
<p class="references">REFERENCES &amp; RESOURCES</p>


<ol>
<li>The Python's mother site @ <a href="http://www.python.org">www.python.org</a>.</li>
</ol>

</div> <!-- End the content-main division -->

<div id="content-footer">
<p>Latest version tested: Python 2.7.12 and 3.6 under Ubuntu 18.04LTS<br />
Last modified: November, 2018</p>
</div>

</div>  <!-- End the wrap-inner division -->

<!-- footer filled by JavaScript -->
<div id="footer" class="header-footer"><p>&nbsp;</p></div>

</div>  <!-- End the wrap-outer division -->
<!-- @@ end change in v1 -->
</body>
</html>
